<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steps to process input to valid data â€¢ yowie</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Steps to process input to valid data">
<meta property="og:description" content="yowie">
<meta property="og:image" content="https://numbats.github.io/yowie/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">yowie</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to yowie</a>
    </li>
    <li>
      <a href="../articles/raw-to-input-data.html">Steps to process raw data to input data</a>
    </li>
    <li>
      <a href="../articles/input-to-valid-data.html">Steps to process input to valid data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/numbats/yowie/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="input-to-valid-data_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Steps to process input to valid data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/numbats/yowie/blob/master/vignettes/input-to-valid-data.Rmd"><code>vignettes/input-to-valid-data.Rmd</code></a></small>
      <div class="hidden name"><code>input-to-valid-data.Rmd</code></div>

    </div>

    
    
<p>The wages contain some values that are unlikely to be true. To detect these unlikely values, we fitted a robust linear regression to each individual. More specifically, for each individual we fitted the model</p>
<p><span class="math display">\[y_i = \beta_0 + \beta_1 x_i + e_i\]</span> where</p>
<ul>
<li>
<span class="math inline">\(y_i\)</span> is the mean hourly wage in the <span class="math inline">\(i\)</span>-th year,</li>
<li>
<span class="math inline">\(x_i\)</span> is the year and</li>
<li>
<span class="math inline">\(e_i\)</span> is the <span class="math inline">\(i\)</span>-th error term,</li>
</ul>
<p>using the iterated re-weighted least squares (IWLS) process.</p>
<p>Observations with weights (used in the IWLS process) less than 0.12 are modified as missing values. An alternative wage is predicted from the fitted robust linear regression model for these censored values and stored in another variable. The threshold of the weights was determined by visualising the effect of different thresholds using the shiny app found <a href="https://ebsmonash.shinyapps.io/yowie_app/">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span>
<span class="va">select</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>
<span class="va">wages_before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"paper/results/wages_before.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># nest the data by id to build a robust linear model</span>
<span class="va">by_id</span> <span class="op">&lt;-</span> <span class="va">wages_before</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">year</span>, <span class="va">mean_hourly_wage</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span>

<span class="co"># build a robust linear model</span>
<span class="va">id_rlm</span> <span class="op">&lt;-</span> <span class="va">by_id</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/rlm.html">rlm</a></span><span class="op">(</span><span class="va">mean_hourly_wage</span> <span class="op">~</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># extract the properties of regression model and weight of each observation</span>

<span class="va">id_aug_w</span> <span class="op">&lt;-</span> <span class="va">id_rlm</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.fitted <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">fitted</span><span class="op">)</span>,
         .resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">resid</span><span class="op">)</span>,
         .hat <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">hatvalues</span><span class="op">)</span>,
         .sigma <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">sigma</span><span class="op">)</span>,
         w <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="va">.x</span><span class="op">$</span><span class="va">w</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">model</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">data</span><span class="op">:</span><span class="va">w</span><span class="op">)</span>

<span class="co"># if the weight &lt; 0.12, the mean_hourly_wage is replaced by the model's fitted/predicted value.</span>
<span class="co"># and add the flag whether the observation is predicted value or not.</span>
<span class="co"># since the fitted value is sometimes &lt;0, and wages value could never be negative,</span>
<span class="co"># we keep the mean hourly wage value even its weight &lt; 0.12.</span>

<span class="va">wages_rlm_dat</span> <span class="op">&lt;-</span> <span class="va">id_aug_w</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>wages_rlm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;</span> <span class="fl">0.12</span>  <span class="op">&amp;</span> <span class="va">.fitted</span> <span class="op">&gt;=</span> <span class="fl">0</span>, <span class="va">.fitted</span>,
                            <span class="va">mean_hourly_wage</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>is_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;</span> <span class="fl">0.12</span> <span class="op">&amp;</span> <span class="va">.fitted</span> <span class="op">&gt;=</span> <span class="fl">0</span>, <span class="cn">TRUE</span>,
                          <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">year</span>, <span class="va">wages_rlm</span>, <span class="va">is_pred</span><span class="op">)</span>

<span class="co"># join back the `wages_rlm_dat` to `wages_demog_hs`</span>

<span class="va">wages_after</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">wages_before</span>, <span class="va">wages_rlm_dat</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wages_after</span>
<span class="co">#&gt; # A tibble: 103,994 Ã— 18</span>
<span class="co">#&gt;       id  year mean_hourly_wage total_hours number_of_jobs is_wm dob_month</span>
<span class="co">#&gt;    &lt;int&gt; &lt;dbl&gt;            &lt;dbl&gt;       &lt;int&gt;          &lt;dbl&gt; &lt;lgl&gt;     &lt;int&gt;</span>
<span class="co">#&gt;  1     2  1979             3.85          35              1 FALSE         1</span>
<span class="co">#&gt;  2     2  1980             4.57          NA              1 FALSE         1</span>
<span class="co">#&gt;  3     2  1981             5.14          NA              1 FALSE         1</span>
<span class="co">#&gt;  4     2  1982             5.71          35              1 FALSE         1</span>
<span class="co">#&gt;  5     2  1983             5.71          NA              1 FALSE         1</span>
<span class="co">#&gt;  6     2  1984             5.14          NA              1 FALSE         1</span>
<span class="co">#&gt;  7     2  1985             7.71          NA              1 FALSE         1</span>
<span class="co">#&gt;  8     2  1986             7.69          NA              1 FALSE         1</span>
<span class="co">#&gt;  9     2  1987             8.79          NA              1 FALSE         1</span>
<span class="co">#&gt; 10     2  1988             6.67          NA              2 FALSE         1</span>
<span class="co">#&gt; # â€¦ with 103,984 more rows, and 11 more variables: dob_year &lt;int&gt;,</span>
<span class="co">#&gt; #   dob_conflict &lt;lgl&gt;, race &lt;fct&gt;, gender &lt;fct&gt;, yr_hgc &lt;dbl&gt;, hgc_i &lt;int&gt;,</span>
<span class="co">#&gt; #   hgc &lt;chr&gt;, age_1979 &lt;dbl&gt;, years_in_workforce &lt;dbl&gt;, wages_rlm &lt;dbl&gt;,</span>
<span class="co">#&gt; #   is_pred &lt;lgl&gt;</span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://datain360.com">Dewi Amaliah</a>, <a href="http://dicook.org">Di Cook</a>, <a href="https://emitanaka.org">Emi Tanaka</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
